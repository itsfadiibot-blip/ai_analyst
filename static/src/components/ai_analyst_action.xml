<?xml version="1.0" encoding="utf-8"?>
<templates xml:space="preserve">

    <t t-name="ai_analyst.AiAnalystAction">
        <div t-att-class="'ai-analyst-container aiAnalystApp d-flex h-100 ' + (state.consoleMode ? 'aiConsoleMode' : '')">

            <!-- ============================================================
                 SIDEBAR — Conversation list
                 ============================================================ -->
            <div t-att-class="'ai-analyst-sidebar border-end ' + (state.sidebarOpen ? '' : 'd-none')"
                 style="width: 280px; min-width: 280px;">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">AI Analyst</h5>
                    <button class="aiBtn aiBtnPrimary aiBtnSm" t-on-click="startNewChat"
                            title="New Chat">
                        + New
                    </button>
                </div>
                <div class="ai-analyst-conv-list overflow-auto" style="max-height: calc(100vh - 120px);">
                    <t t-foreach="state.conversations" t-as="conv" t-key="conv.id">
                        <div t-att-class="'ai-analyst-conv-item p-2 px-3 border-bottom cursor-pointer '
                             + (state.currentConversationId === conv.id ? 'bg-primary-subtle' : '')"
                             t-on-click="() => this.selectConversation(conv.id)">
                            <div class="fw-semibold text-truncate" style="font-size: 13px;">
                                <t t-esc="conv.name || 'Untitled'"/>
                            </div>
                            <div class="text-muted" style="font-size: 11px;">
                                <t t-esc="formatDate(conv.write_date)"/>
                                <span class="ms-2 badge bg-secondary-subtle text-secondary">
                                    <t t-esc="conv.message_count"/> msgs
                                </span>
                            </div>
                        </div>
                    </t>
                    <div t-if="!state.conversations.length" class="p-3 text-muted text-center">
                        <p>No conversations yet.</p>
                        <p>Ask a question to get started!</p>
                    </div>
                </div>
            </div>

            <!-- ============================================================
                 MAIN CHAT AREA
                 ============================================================ -->
            <div class="ai-analyst-main flex-grow-1 d-flex flex-column">

                <!-- Top bar -->
                <div class="ai-analyst-topbar p-2 px-3 border-bottom d-flex align-items-center gap-2">
                    <button class="aiBtn aiIconBtn" t-on-click="toggleSidebar"
                            title="Toggle Sidebar">
                        ☰
                    </button>
                    <WorkspaceSelector
                        workspaces="state.workspaces"
                        selectedWorkspaceId="state.selectedWorkspaceId"
                        toolNames="state.workspaceToolNames"
                        onSelect.bind="onWorkspaceSelect"/>
                    <span class="fw-semibold flex-grow-1">
                        <t t-if="state.currentConversationId">
                            Conversation
                        </t>
                        <t t-else="">
                            New Conversation
                        </t>
                    </span>
                    <label class="form-check form-switch m-0 d-flex align-items-center gap-1">
                        <input class="form-check-input" type="checkbox" t-att-checked="state.consoleMode" t-on-change="toggleConsoleMode"/>
                        <span class="small">Console Mode</span>
                    </label>
                </div>

                <!-- Messages area -->
                <div class="ai-analyst-messages flex-grow-1 overflow-auto p-3"
                     t-ref="chatContainer">

                    <!-- Welcome screen when no messages -->
                    <div t-if="!state.messages.length" class="text-center py-5">
                        <div style="font-size: 48px; opacity: 0.3;">&#129302;</div>
                        <h4 class="text-muted mt-3">
                            <t t-if="state.selectedWorkspaceId and state.workspaces.length">
                                <t t-esc="state.workspaces.find(w => w.id === state.selectedWorkspaceId)?.name || 'AI Analyst'"/>
                            </t>
                            <t t-else="">AI Analyst</t>
                        </h4>
                        <p class="text-muted">
                            Ask any business question about your data.
                        </p>

                        <!-- Workspace-specific prompts -->
                        <div t-if="state.workspacePrompts.length"
                             class="d-flex flex-wrap gap-2 justify-content-center mt-4"
                             style="max-width: 700px; margin: 0 auto;">
                            <t t-foreach="state.workspacePrompts" t-as="prompt" t-key="prompt_index">
                                <button class="aiChip"
                                        t-att-title="prompt.text"
                                        t-on-click="() => { this.state.inputText = prompt.text; }">
                                    <i t-if="prompt.icon" t-att-class="'fa ' + prompt.icon + ' me-1'"/>
                                    <t t-esc="prompt.description || prompt.text.substring(0, 40)"/>
                                </button>
                            </t>
                        </div>

                        <!-- Default prompts (when no workspace selected) -->
                        <div t-if="!state.workspacePrompts.length"
                             class="d-flex flex-wrap gap-2 justify-content-center mt-4"
                             style="max-width: 600px; margin: 0 auto;">
                            <button class="aiChip"
                                    t-on-click="() => { this.state.inputText = 'What was total sales last month? Compare to previous month.'; }">
                                Sales last month
                            </button>
                            <button class="aiChip"
                                    t-on-click="() => { this.state.inputText = 'Top 20 products by revenue for the last 30 days'; }">
                                Top 20 products
                            </button>
                            <button class="aiChip"
                                    t-on-click="() => { this.state.inputText = 'POS vs Online sales for the last 90 days'; }">
                                POS vs Online
                            </button>
                            <button class="aiChip"
                                    t-on-click="() => { this.state.inputText = 'AR aging summary'; }">
                                AR Aging
                            </button>
                            <button class="aiChip"
                                    t-on-click="() => { this.state.inputText = 'Show slow-moving inventory over 60 days'; }">
                                Slow-moving stock
                            </button>
                            <button class="aiChip"
                                    t-on-click="() => { this.state.inputText = 'Refund rate and impact on revenue last quarter'; }">
                                Refund impact
                            </button>
                        </div>
                    </div>

                    <!-- Message list -->
                    <t t-foreach="state.messages" t-as="msg" t-key="msg_index">

                        <!-- USER MESSAGE -->
                        <div t-if="msg.role === 'user'" class="ai-msg ai-msg-user mb-3">
                            <div class="d-flex justify-content-end">
                                <div class="ai-msg-bubble ai-msg-user-bubble p-3 rounded-3"
                                     style="max-width: 75%; background: #e3f2fd;">
                                    <div style="white-space: pre-wrap;"><t t-esc="msg.content"/></div>
                                    <div class="text-muted mt-1" style="font-size: 11px;">
                                        <t t-esc="formatTime(msg.create_date)"/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ASSISTANT MESSAGE -->
                        <div t-if="msg.role === 'assistant'" class="ai-msg ai-msg-assistant mb-4">
                            <div class="ai-msg-bubble ai-msg-assistant-bubble p-3 rounded-3 border"
                                 style="max-width: 95%; background: #fafafa;">

                                <!-- Error -->
                                <div t-if="msg.structured_response and msg.structured_response.error"
                                     class="alert alert-warning mb-2" role="alert">
                                    <t t-esc="msg.structured_response.error"/>
                                </div>

                                <!-- Answer text -->
                                <div class="ai-answer mb-2" style="white-space: pre-wrap; line-height: 1.6;">
                                    <t t-esc="msg.content || msg.structured_response?.answer || ''"/>
                                </div>

                                <!-- KPI Cards -->
                                <t t-if="msg.structured_response and msg.structured_response.kpis and msg.structured_response.kpis.length">
                                    <div class="ai-kpi-grid d-flex flex-wrap gap-2 my-3">
                                        <t t-foreach="msg.structured_response.kpis" t-as="kpi" t-key="kpi_index">
                                            <div class="ai-kpi-card border rounded-3 p-3 text-center"
                                                 style="min-width: 140px; flex: 1; background: white;">
                                                <div class="text-muted" style="font-size: 12px;">
                                                    <t t-esc="kpi.label"/>
                                                </div>
                                                <div class="fw-bold mt-1" style="font-size: 20px;">
                                                    <t t-esc="kpi.value"/>
                                                </div>
                                                <div t-if="kpi.delta" class="mt-1" style="font-size: 13px;"
                                                     t-att-class="kpi.delta_direction === 'up' ? 'text-success'
                                                                : kpi.delta_direction === 'down' ? 'text-danger'
                                                                : 'text-muted'">
                                                    <t t-esc="kpi.delta"/>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                </t>

                                <!-- Data Table -->
                                <t t-if="msg.structured_response and msg.structured_response.table
                                         and msg.structured_response.table.columns">
                                    <div class="ai-table-container my-3 overflow-auto border rounded"
                                         style="max-height: 400px;">
                                        <table class="table table-sm table-hover table-striped mb-0">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <t t-foreach="msg.structured_response.table.columns"
                                                       t-as="col" t-key="col.key">
                                                        <th t-att-class="col.align === 'right' ? 'text-end'
                                                                       : col.align === 'center' ? 'text-center'
                                                                       : ''"
                                                            style="font-size: 12px;">
                                                            <t t-esc="col.label"/>
                                                        </th>
                                                    </t>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="msg.structured_response.table.rows"
                                                   t-as="row" t-key="row_index">
                                                    <tr>
                                                        <t t-foreach="msg.structured_response.table.columns"
                                                           t-as="col" t-key="col.key">
                                                            <td t-att-class="col.align === 'right' ? 'text-end'
                                                                           : col.align === 'center' ? 'text-center'
                                                                           : ''"
                                                                style="font-size: 13px;">
                                                                <t t-esc="row[col.key]"/>
                                                            </td>
                                                        </t>
                                                    </tr>
                                                </t>
                                                <!-- Total row -->
                                                <t t-if="msg.structured_response.table.total_row">
                                                    <tr class="fw-bold table-secondary">
                                                        <t t-foreach="msg.structured_response.table.columns"
                                                           t-as="col" t-key="col.key">
                                                            <td t-att-class="col.align === 'right' ? 'text-end'
                                                                           : col.align === 'center' ? 'text-center'
                                                                           : ''">
                                                                <t t-esc="msg.structured_response.table.total_row[col.key] || ''"/>
                                                            </td>
                                                        </t>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>

                                <!-- Chart -->
                                <t t-if="msg.structured_response and msg.structured_response.chart">
                                    <div class="ai-chart-container my-3 border rounded p-2"
                                         style="max-height: 400px; position: relative;"
                                         t-att-data-chart-index="msg_index">
                                        <canvas style="max-height: 380px; width: 100%;"></canvas>
                                    </div>
                                </t>

                                <!-- Action buttons -->
                                <div class="ai-actions mt-2 d-flex gap-2 flex-wrap">
                                    <t t-if="msg.structured_response and msg.structured_response.actions">
                                        <t t-foreach="msg.structured_response.actions" t-as="act" t-key="act_index">
                                            <button t-if="act.type === 'download_csv'"
                                                    class="aiBtn aiIconBtn"
                                                    t-on-click="() => this.downloadCsv(msg.structured_response)">
                                                Download CSV
                                            </button>
                                        </t>
                                    </t>
                                    <button t-if="msg.structured_response and !msg.structured_response.error"
                                            class="aiBtn aiIconBtn"
                                            t-on-click="() => this.saveReport(msg_index)">
                                        Save Report
                                    </button>
                                </div>

                                <!-- Meta info -->
                                <t t-if="msg.structured_response and msg.structured_response.meta">
                                    <div class="ai-meta text-muted mt-2 pt-2 border-top"
                                         style="font-size: 11px;">
                                        <t t-if="msg.structured_response.meta.tool_calls">
                                            <span>
                                                <t t-esc="msg.structured_response.meta.tool_calls.length"/> tool call(s)
                                            </span>
                                            <span class="mx-1">|</span>
                                        </t>
                                        <t t-if="msg.structured_response.meta.total_time_ms">
                                            <span>
                                                <t t-esc="(msg.structured_response.meta.total_time_ms / 1000).toFixed(1)"/>s
                                            </span>
                                            <span class="mx-1">|</span>
                                        </t>
                                        <t t-if="msg.structured_response.meta.model">
                                            <span><t t-esc="msg.structured_response.meta.model"/></span>
                                        </t>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </t>

                    <!-- Loading indicator -->
                    <div t-if="state.isLoading" class="ai-loading mb-3">
                        <div class="ai-msg-bubble p-3 rounded-3 border"
                             style="max-width: 200px; background: #fafafa;">
                            <div class="d-flex align-items-center gap-2">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Analyzing...</span>
                                </div>
                                <span class="text-muted">Analyzing...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================================
                     INPUT BAR
                     ============================================================ -->
                <div class="ai-analyst-input border-top p-3">
                    <div class="d-flex gap-2 align-items-end"
                         style="max-width: 900px; margin: 0 auto;">
                        <textarea
                            t-ref="chatInput"
                            class="form-control"
                            t-att-value="state.inputText"
                            t-on-input="(ev) => { this.state.inputText = ev.target.value; }"
                            t-on-keydown="onInputKeydown"
                            placeholder="Ask a question about your business data..."
                            rows="1"
                            style="resize: none; max-height: 120px; min-height: 40px;"
                            t-att-disabled="state.isLoading"
                        />
                        <button
                            class="aiBtn aiBtnPrimary"
                            t-on-click="sendMessage"
                            t-att-disabled="state.isLoading || !state.inputText.trim()"
                            style="min-width: 70px; height: 40px;">
                            <t t-if="state.isLoading">
                                <span class="spinner-border spinner-border-sm"/>
                            </t>
                            <t t-else="">Send</t>
                        </button>
                    </div>
                    <div class="text-center text-muted mt-1" style="font-size: 11px;">
                        Press Enter to send, Shift+Enter for new line
                    </div>
                </div>
            </div>
        </div>
    </t>

</templates>
